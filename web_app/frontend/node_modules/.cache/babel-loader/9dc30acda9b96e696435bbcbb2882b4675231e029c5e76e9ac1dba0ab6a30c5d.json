{"ast":null,"code":"import React,{useEffect,useRef,useState}from'react';import{Card,Button,Space,message,Spin,Tag}from'antd';import{NodeIndexOutlined,ReloadOutlined}from'@ant-design/icons';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const EntityGraphVisualization=_ref=>{let{noteId,onClose}=_ref;const[graphData,setGraphData]=useState(null);const[loading,setLoading]=useState(false);const[extracting,setExtracting]=useState(false);const canvasRef=useRef(null);const[selectedNode,setSelectedNode]=useState(null);const fetchGraphData=async()=>{setLoading(true);try{const token=localStorage.getItem('token');const response=await fetch(`/api/v1/notes/${noteId}/graph`,{headers:{'Authorization':`Bearer ${token}`}});if(!response.ok){throw new Error('获取图谱数据失败');}const data=await response.json();console.log('获取到的图谱数据:',data);setGraphData(data);// 绘制图谱\nsetTimeout(()=>drawGraph(data),100);}catch(error){console.error('获取图谱数据失败:',error);message.error(error.message||'获取图谱数据失败');}finally{setLoading(false);}};useEffect(()=>{fetchGraphData();},[noteId]);const handleReExtractEntities=async()=>{setExtracting(true);try{const token=localStorage.getItem('token');console.log('开始重新抽取实体，笔记ID:',noteId);const response=await fetch(`/api/v1/notes/${noteId}/extract-entities`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});if(!response.ok){const errorData=await response.json();throw new Error(errorData.detail||'重新抽取实体失败');}const result=await response.json();console.log('重新抽取实体结果:',result);message.success(`实体重新抽取成功！提取了 ${result.entity_count} 个实体，${result.relation_count} 个关系`);// 重新获取图谱数据\nawait fetchGraphData();}catch(error){console.error('重新抽取实体失败:',error);message.error(error.message||'重新抽取实体失败');}finally{setExtracting(false);}};const drawGraph=data=>{const canvas=canvasRef.current;if(!canvas)return;const ctx=canvas.getContext('2d');if(!ctx)return;// 设置画布大小\ncanvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;// 清空画布\nctx.clearRect(0,0,canvas.width,canvas.height);const nodes=data.graph_nodes;const edges=data.graph_edges;console.log('绘制图谱 - 节点数:',nodes.length,'边数:',edges.length);if(nodes.length===0){// 如果没有节点，显示提示信息\nctx.fillStyle='#999';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('暂无实体数据',canvas.width/2,canvas.height/2);return;}// 简单的力导向布局\nconst nodePositions=new Map();const centerX=canvas.width/2;const centerY=canvas.height/2;const radius=Math.min(canvas.width,canvas.height)/4;// 为节点分配位置\nif(nodes.length===1){// 单个节点放在中心\nnodePositions.set(nodes[0].id,{x:centerX,y:centerY});}else{// 多个节点围成圆形\nnodes.forEach((node,index)=>{const angle=index/nodes.length*2*Math.PI;const x=centerX+Math.cos(angle)*radius;const y=centerY+Math.sin(angle)*radius;nodePositions.set(node.id,{x,y});});}// 绘制边\nedges.forEach(edge=>{const sourcePos=nodePositions.get(edge.source);const targetPos=nodePositions.get(edge.target);if(sourcePos&&targetPos){// 根据关系类型设置不同的样式\nconst isInternal=edge.source_note===`note_${noteId}`;ctx.strokeStyle=isInternal?'#722ed1':'#eb2f96';ctx.lineWidth=isInternal?3:2;ctx.setLineDash(isInternal?[]:[5,5]);ctx.beginPath();ctx.moveTo(sourcePos.x,sourcePos.y);ctx.lineTo(targetPos.x,targetPos.y);ctx.stroke();// 重置线条样式\nctx.setLineDash([]);// 绘制边标签\nconst midX=(sourcePos.x+targetPos.x)/2;const midY=(sourcePos.y+targetPos.y)/2;ctx.fillStyle='#666';ctx.font='12px Arial';ctx.textAlign='center';ctx.fillText(edge.type,midX,midY-5);// 绘制置信度\nif(edge.confidence<1){ctx.fillStyle='#999';ctx.font='10px Arial';ctx.fillText(`${Math.round(edge.confidence*100)}%`,midX,midY+10);}}});// 绘制节点\nnodes.forEach(node=>{const pos=nodePositions.get(node.id);if(!pos)return;// 节点颜色和大小\nconst color=data.visualization_config.node_colors[node.status]||'#ccc';const radius=node.source==='note'?35:25;// 来自笔记的节点更大\n// 绘制节点阴影\nctx.beginPath();ctx.arc(pos.x+2,pos.y+2,radius,0,2*Math.PI);ctx.fillStyle='rgba(0, 0, 0, 0.2)';ctx.fill();// 绘制节点圆圈\nctx.beginPath();ctx.arc(pos.x,pos.y,radius,0,2*Math.PI);ctx.fillStyle=color;ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.stroke();// 绘制状态指示器\nif(node.status==='new'){ctx.beginPath();ctx.arc(pos.x+radius-8,pos.y-radius+8,6,0,2*Math.PI);ctx.fillStyle='#52c41a';ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();}else if(node.status==='enhanced'){ctx.beginPath();ctx.arc(pos.x+radius-8,pos.y-radius+8,6,0,2*Math.PI);ctx.fillStyle='#1890ff';ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();}// 绘制节点标签\nctx.fillStyle='#000';ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.fillText(node.name,pos.x,pos.y+radius+20);// 绘制置信度\nif(node.confidence<1){ctx.fillStyle='#999';ctx.font='10px Arial';ctx.fillText(`${Math.round(node.confidence*100)}%`,pos.x,pos.y+radius+35);}});};const handleCanvasClick=event=>{if(!graphData)return;const canvas=canvasRef.current;if(!canvas)return;const rect=canvas.getBoundingClientRect();const x=event.clientX-rect.left;const y=event.clientY-rect.top;// 检查点击的节点\nconst nodes=graphData.graph_nodes;const centerX=canvas.width/2;const centerY=canvas.height/2;const radius=Math.min(canvas.width,canvas.height)/3;for(let i=0;i<nodes.length;i++){const node=nodes[i];const angle=i/nodes.length*2*Math.PI;const nodeX=centerX+Math.cos(angle)*radius;const nodeY=centerY+Math.sin(angle)*radius;const distance=Math.sqrt((x-nodeX)**2+(y-nodeY)**2);if(distance<=30){setSelectedNode(node);break;}}};const getStatusColor=status=>{const colors={'new':'green','enhanced':'blue','existing':'orange'};return colors[status]||'default';};const getStatusText=status=>{const texts={'new':'新增实体','enhanced':'增强实体','existing':'已存在'};return texts[status]||status;};return/*#__PURE__*/_jsx(\"div\",{style:{height:'100%',display:'flex',flexDirection:'column'},children:/*#__PURE__*/_jsx(Card,{title:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',justifyContent:'space-between'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'8px'},children:[/*#__PURE__*/_jsx(NodeIndexOutlined,{}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u5B9E\\u4F53\\u77E5\\u8BC6\\u56FE\\u8C31\\u96C6\\u6210\"})]}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(ReloadOutlined,{}),onClick:fetchGraphData,loading:loading,children:\"\\u5237\\u65B0\\u56FE\\u8C31\"}),/*#__PURE__*/_jsx(Button,{type:\"primary\",loading:extracting,onClick:handleReExtractEntities,children:\"\\u91CD\\u65B0\\u62BD\\u53D6\\u5B9E\\u4F53\"}),/*#__PURE__*/_jsx(Button,{onClick:()=>{// 这里可以跳转到完整的知识图谱页面\nmessage.info('完整知识图谱功能开发中...');},children:\"\\u67E5\\u770B\\u5B8C\\u6574\\u56FE\\u8C31\"}),onClose&&/*#__PURE__*/_jsx(Button,{onClick:onClose,children:\"\\u5173\\u95ED\"})]})]}),style:{flex:1,display:'flex',flexDirection:'column'},bodyStyle:{flex:1,display:'flex',flexDirection:'column'},children:/*#__PURE__*/_jsx(Spin,{spinning:loading,children:graphData&&/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,display:'flex',gap:'16px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{flex:2,display:'flex',flexDirection:'column'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'16px'},children:[/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:'8px'},children:/*#__PURE__*/_jsx(\"strong\",{children:\"\\u77E5\\u8BC6\\u56FE\\u8C31\\u96C6\\u6210\\u7EDF\\u8BA1\\uFF1A\"})}),/*#__PURE__*/_jsxs(Space,{wrap:true,children:[/*#__PURE__*/_jsxs(Tag,{color:\"green\",children:[\"\\u65B0\\u589E\\u5B9E\\u4F53: \",graphData.integration_stats.new_entities]}),/*#__PURE__*/_jsxs(Tag,{color:\"blue\",children:[\"\\u589E\\u5F3A\\u5B9E\\u4F53: \",graphData.integration_stats.enhanced_entities]}),/*#__PURE__*/_jsxs(Tag,{color:\"orange\",children:[\"\\u603B\\u5B9E\\u4F53: \",graphData.integration_stats.total_entities]}),/*#__PURE__*/_jsxs(Tag,{color:\"purple\",children:[\"\\u96C6\\u6210\\u5B9E\\u4F53: \",graphData.integration_stats.integrated_entities]})]}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:'8px',fontSize:'12px',color:'#666'},children:\"\\uD83D\\uDCA1 \\u7EFF\\u8272\\u8868\\u793A\\u65B0\\u52A0\\u5165\\u77E5\\u8BC6\\u56FE\\u8C31\\u7684\\u5B9E\\u4F53\\uFF0C\\u84DD\\u8272\\u8868\\u793A\\u589E\\u5F3A\\u4E86\\u73B0\\u6709\\u56FE\\u8C31\\u5B9E\\u4F53\"})]}),/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef,style:{flex:1,border:'1px solid #d9d9d9',borderRadius:'6px',cursor:'pointer',minHeight:'400px'},onClick:handleCanvasClick})]}),/*#__PURE__*/_jsx(\"div\",{style:{flex:1,maxWidth:'300px'},children:/*#__PURE__*/_jsx(Card,{size:\"small\",title:\"\\u5B9E\\u4F53\\u8BE6\\u60C5\",children:selectedNode?/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'12px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:selectedNode.name}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:'4px'},children:/*#__PURE__*/_jsx(Tag,{color:getStatusColor(selectedNode.status),children:getStatusText(selectedNode.status)})})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u7C7B\\u578B:\"}),\" \",selectedNode.type]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u7F6E\\u4FE1\\u5EA6:\"}),\" \",Math.round(selectedNode.confidence*100),\"%\"]}),selectedNode.description&&/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u63CF\\u8FF0:\"}),\" \",selectedNode.description]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u6765\\u6E90:\"}),\" \",selectedNode.source==='note'?'笔记':'知识图谱']}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u56FE\\u8C31\\u72B6\\u6001:\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'4px'},children:[/*#__PURE__*/_jsx(Tag,{color:getStatusColor(selectedNode.status),children:getStatusText(selectedNode.status)}),selectedNode.status==='enhanced'&&/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'12px',color:'#666',marginTop:'2px'},children:\"\\u6B64\\u5B9E\\u4F53\\u5DF2\\u5B58\\u5728\\u4E8E\\u77E5\\u8BC6\\u56FE\\u8C31\\u4E2D\\uFF0C\\u901A\\u8FC7\\u6B64\\u7B14\\u8BB0\\u5F97\\u5230\\u4E86\\u589E\\u5F3A\"}),selectedNode.status==='new'&&/*#__PURE__*/_jsx(\"div\",{style:{fontSize:'12px',color:'#666',marginTop:'2px'},children:\"\\u6B64\\u5B9E\\u4F53\\u662F\\u901A\\u8FC7\\u6B64\\u7B14\\u8BB0\\u65B0\\u52A0\\u5165\\u77E5\\u8BC6\\u56FE\\u8C31\\u7684\"})]})]}),graphData.entity_details.map((detail,index)=>{if(detail.entity.id===selectedNode.id){return/*#__PURE__*/_jsxs(\"div\",{children:[detail.related_concepts.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'8px'},children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u76F8\\u5173\\u6982\\u5FF5:\"}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:'4px'},children:detail.related_concepts.map((concept,i)=>/*#__PURE__*/_jsx(Tag,{size:\"small\",children:concept},i))})]}),detail.integration_path.length>0&&/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u96C6\\u6210\\u8DEF\\u5F84:\"}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:'4px'},children:detail.integration_path.join(' → ')})]})]},index);}return null;})]}):/*#__PURE__*/_jsx(\"div\",{style:{textAlign:'center',color:'#999',padding:'20px'},children:\"\\u70B9\\u51FB\\u56FE\\u8C31\\u4E2D\\u7684\\u8282\\u70B9\\u67E5\\u770B\\u8BE6\\u60C5\"})})})]})})})});};export default EntityGraphVisualization;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}