# AlgoKG Webåº”ç”¨ Makefile

.PHONY: help install dev test build clean docker-build docker-run stop

# é»˜è®¤ç›®æ ‡
help:
	@echo "AlgoKGæ™ºèƒ½é—®ç­”Webåº”ç”¨"
	@echo "======================"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  install     - å®‰è£…æ‰€æœ‰ä¾èµ–"
	@echo "  dev         - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
	@echo "  test        - è¿è¡Œç³»ç»Ÿæµ‹è¯•"
	@echo "  build       - æ„å»ºç”Ÿäº§ç‰ˆæœ¬"
	@echo "  clean       - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  docker-build - æ„å»ºDockeré•œåƒ"
	@echo "  docker-run  - è¿è¡ŒDockerå®¹å™¨"
	@echo "  stop        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo ""

# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	@echo "å®‰è£…åç«¯ä¾èµ–..."
	cd backend && python -m venv venv && \
	(. venv/bin/activate || venv\Scripts\activate.bat) && \
	pip install -r requirements.txt
	@echo "å®‰è£…å‰ç«¯ä¾èµ–..."
	cd frontend && npm install
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@if [ -f scripts/start-dev.sh ]; then \
		chmod +x scripts/start-dev.sh && ./scripts/start-dev.sh; \
	elif [ -f scripts/start-dev.bat ]; then \
		scripts/start-dev.bat; \
	else \
		echo "âŒ å¯åŠ¨è„šæœ¬ä¸å­˜åœ¨"; \
	fi

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œç³»ç»Ÿæµ‹è¯•..."
	python scripts/test-system.py

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
build:
	@echo "ğŸ—ï¸  æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
	@echo "æ„å»ºå‰ç«¯..."
	cd frontend && npm run build
	@echo "âœ… æ„å»ºå®Œæˆ"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	rm -rf backend/venv
	rm -rf backend/__pycache__
	rm -rf backend/app/__pycache__
	rm -rf frontend/node_modules
	rm -rf frontend/build
	rm -f stop-dev.sh
	docker-compose down --volumes --remove-orphans
	@echo "âœ… æ¸…ç†å®Œæˆ"

# æ„å»ºDockeré•œåƒ
docker-build:
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	docker-compose build
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

# è¿è¡ŒDockerå®¹å™¨
docker-run:
	@echo "ğŸ³ å¯åŠ¨Dockerå®¹å™¨..."
	docker-compose up -d
	@echo "âœ… Dockerå®¹å™¨å¯åŠ¨å®Œæˆ"
	@echo ""
	@echo "ğŸ“± å‰ç«¯åœ°å€: http://localhost:3000"
	@echo "ğŸ”§ åç«¯API: http://localhost:8000"
	@echo "ğŸ“Š APIæ–‡æ¡£: http://localhost:8000/docs"
	@echo "ğŸ—„ï¸  Neo4jæµè§ˆå™¨: http://localhost:7474"

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@if [ -f stop-dev.sh ]; then ./stop-dev.sh; fi
	docker-compose stop
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	docker-compose logs -f

# é‡å¯æœåŠ¡
restart: stop docker-run

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@curl -s http://localhost:8000/health | python -m json.tool || echo "åç«¯æœåŠ¡ä¸å¯ç”¨"
	@curl -s http://localhost:3000 > /dev/null && echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸" || echo "âŒ å‰ç«¯æœåŠ¡ä¸å¯ç”¨"

# æ•°æ®åº“åˆå§‹åŒ–
init-db:
	@echo "ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“..."
	docker-compose exec neo4j cypher-shell -u neo4j -p 123456 "CREATE CONSTRAINT IF NOT EXISTS FOR (n:Problem) REQUIRE n.id IS UNIQUE;"
	docker-compose exec neo4j cypher-shell -u neo4j -p 123456 "CREATE CONSTRAINT IF NOT EXISTS FOR (n:Algorithm) REQUIRE n.name IS UNIQUE;"
	@echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"

# å¤‡ä»½æ•°æ®
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®..."
	mkdir -p backups
	docker-compose exec neo4j neo4j-admin dump --database=neo4j --to=/tmp/neo4j-backup.dump
	docker cp $$(docker-compose ps -q neo4j):/tmp/neo4j-backup.dump backups/neo4j-backup-$$(date +%Y%m%d-%H%M%S).dump
	@echo "âœ… æ•°æ®å¤‡ä»½å®Œæˆ"

# æ¢å¤æ•°æ®
restore:
	@echo "ğŸ“¥ æ¢å¤æ•°æ®..."
	@if [ -z "$(BACKUP_FILE)" ]; then \
		echo "âŒ è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶: make restore BACKUP_FILE=path/to/backup.dump"; \
		exit 1; \
	fi
	docker-compose stop neo4j
	docker cp $(BACKUP_FILE) $$(docker-compose ps -q neo4j):/tmp/restore.dump
	docker-compose exec neo4j neo4j-admin load --from=/tmp/restore.dump --database=neo4j --force
	docker-compose start neo4j
	@echo "âœ… æ•°æ®æ¢å¤å®Œæˆ"
