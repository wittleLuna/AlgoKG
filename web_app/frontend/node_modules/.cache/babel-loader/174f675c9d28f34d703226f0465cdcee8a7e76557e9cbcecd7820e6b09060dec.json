{"ast":null,"code":"import React,{useState,useEffect,useCallback}from'react';import{Card,Typography,Button,Space,Tooltip,Select,Input,Tag,message,Switch,Row,Col,Spin,Drawer}from'antd';import{SearchOutlined,SettingOutlined,ReloadOutlined,MessageOutlined,BulbOutlined,FilterOutlined}from'@ant-design/icons';import EnhancedGraphVisualization from'./EnhancedGraphVisualization';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const{Title,Text}=Typography;const{Option}=Select;const{Search}=Input;const UnifiedGraphVisualization=_ref=>{let{data,onNodeClick,height=600,showControls=true,defaultDataSources=['neo4j'],showAnimation=true,disableBuiltinNodeDetail=false,disableEnhancedNodeInfo=false}=_ref;const[loading,setLoading]=useState(false);const[graphData,setGraphData]=useState(data);const[selectedDataSources,setSelectedDataSources]=useState(defaultDataSources);const[searchQuery,setSearchQuery]=useState('');const[showSettings,setShowSettings]=useState(false);const[nodeDetails,setNodeDetails]=useState(null);const[showNodeDetails,setShowNodeDetails]=useState(false);// 数据源配置\nconst[dataSources,setDataSources]=useState([{key:'neo4j',label:'Neo4j图谱',icon:/*#__PURE__*/_jsx(MessageOutlined,{}),description:'基于Neo4j数据库的实时知识图谱',enabled:true},{key:'embedding',label:'智能推荐',icon:/*#__PURE__*/_jsx(BulbOutlined,{}),description:'基于embedding的智能题目推荐图谱',enabled:false},{key:'static',label:'静态图谱',icon:/*#__PURE__*/_jsx(FilterOutlined,{}),description:'预定义的静态知识图谱',enabled:false}]);// 更新图谱数据\nuseEffect(()=>{setGraphData(data);},[data]);// 查询统一图谱\nconst queryUnifiedGraph=useCallback(async(query,sources)=>{if(!query.trim()){message.warning('请输入查询关键词');return;}setLoading(true);try{const params=new URLSearchParams({entity_name:query,depth:'2',limit:'50'});// 添加数据源参数\nsources.forEach(source=>{params.append('data_sources',source);});const response=await fetch(`/api/v1/graph/unified/query?${params}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({entity_name:query,depth:2,limit:50})});if(response.ok){var _result$nodes;const result=await response.json();setGraphData(result);message.success(`查询成功，找到 ${((_result$nodes=result.nodes)===null||_result$nodes===void 0?void 0:_result$nodes.length)||0} 个节点`);}else{throw new Error(`查询失败: ${response.statusText}`);}}catch(error){console.error('统一图谱查询错误:',error);message.error('查询失败，请稍后重试');}finally{setLoading(false);}},[]);// 处理搜索\nconst handleSearch=value=>{setSearchQuery(value);const enabledSources=dataSources.filter(ds=>ds.enabled).map(ds=>ds.key);queryUnifiedGraph(value,enabledSources);};// 处理节点点击\nconst handleNodeClick=async nodeData=>{// 调用外部回调\nif(onNodeClick){onNodeClick(nodeData.id,nodeData);}// 只有在未禁用内置节点详情时才获取详情\nif(!disableBuiltinNodeDetail){try{const response=await fetch(`/api/v1/graph/unified/node/${encodeURIComponent(nodeData.id)}/details?node_type=${nodeData.type}`);if(response.ok){const details=await response.json();setNodeDetails({...nodeData,details});setShowNodeDetails(true);}}catch(error){console.error('获取节点详情失败:',error);}}else{// 禁用时确保不显示内置节点详情\nsetShowNodeDetails(false);setNodeDetails(null);}};// 数据源切换\nconst handleDataSourceToggle=(sourceKey,enabled)=>{setDataSources(prev=>prev.map(ds=>ds.key===sourceKey?{...ds,enabled}:ds));};// 渲染数据源设置\nconst renderDataSourceSettings=()=>/*#__PURE__*/_jsxs(\"div\",{style:{padding:'16px'},children:[/*#__PURE__*/_jsx(Title,{level:5,children:\"\\u6570\\u636E\\u6E90\\u914D\\u7F6E\"}),/*#__PURE__*/_jsx(Space,{direction:\"vertical\",style:{width:'100%'},children:dataSources.map(source=>/*#__PURE__*/_jsx(Card,{size:\"small\",children:/*#__PURE__*/_jsxs(Row,{justify:\"space-between\",align:\"middle\",children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsxs(Space,{children:[source.icon,/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Text,{strong:true,children:source.label}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(Text,{type:\"secondary\",style:{fontSize:'12px'},children:source.description})]})]})}),/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Switch,{checked:source.enabled,onChange:checked=>handleDataSourceToggle(source.key,checked)})})]})},source.key))})]});// 渲染控制面板\nconst renderControls=()=>{if(!showControls)return null;return/*#__PURE__*/_jsxs(Card,{size:\"small\",style:{marginBottom:16},children:[/*#__PURE__*/_jsxs(Row,{gutter:16,align:\"middle\",children:[/*#__PURE__*/_jsx(Col,{flex:\"auto\",children:/*#__PURE__*/_jsx(Search,{placeholder:\"\\u8F93\\u5165\\u5B9E\\u4F53\\u540D\\u79F0\\u8FDB\\u884C\\u56FE\\u8C31\\u67E5\\u8BE2...\",value:searchQuery,onChange:e=>setSearchQuery(e.target.value),onSearch:handleSearch,enterButton:/*#__PURE__*/_jsx(SearchOutlined,{}),size:\"large\"})}),/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Tooltip,{title:\"\\u6570\\u636E\\u6E90\\u8BBE\\u7F6E\",children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(SettingOutlined,{}),onClick:()=>setShowSettings(true)})}),/*#__PURE__*/_jsx(Tooltip,{title:\"\\u5237\\u65B0\",children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(ReloadOutlined,{}),onClick:()=>{if(searchQuery){handleSearch(searchQuery);}}})})]})})]}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:8},children:[/*#__PURE__*/_jsx(Text,{type:\"secondary\",children:\"\\u5DF2\\u542F\\u7528\\u6570\\u636E\\u6E90: \"}),dataSources.filter(ds=>ds.enabled).map(ds=>/*#__PURE__*/_jsx(Tag,{icon:ds.icon,color:\"blue\",style:{marginRight:4},children:ds.label},ds.key))]})]});};// 渲染节点详情\nconst renderNodeDetails=()=>/*#__PURE__*/_jsx(Drawer,{title:`节点详情: ${nodeDetails===null||nodeDetails===void 0?void 0:nodeDetails.label}`,placement:\"right\",width:400,open:showNodeDetails,onClose:()=>setShowNodeDetails(false),children:nodeDetails&&/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsxs(Space,{direction:\"vertical\",style:{width:'100%'},children:[/*#__PURE__*/_jsxs(Card,{size:\"small\",children:[/*#__PURE__*/_jsx(Text,{strong:true,children:\"\\u57FA\\u672C\\u4FE1\\u606F\"}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:8},children:[/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(Text,{type:\"secondary\",children:\"ID:\"}),\" \",nodeDetails.id]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(Text,{type:\"secondary\",children:\"\\u7C7B\\u578B:\"}),\" \",/*#__PURE__*/_jsx(Tag,{children:nodeDetails.type})]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(Text,{type:\"secondary\",children:\"\\u6807\\u7B7E:\"}),\" \",nodeDetails.label]})]})]}),nodeDetails.properties&&/*#__PURE__*/_jsxs(Card,{size:\"small\",children:[/*#__PURE__*/_jsx(Text,{strong:true,children:\"\\u5C5E\\u6027\\u4FE1\\u606F\"}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:8},children:Object.entries(nodeDetails.properties).map(_ref2=>{let[key,value]=_ref2;return/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsxs(Text,{type:\"secondary\",children:[key,\":\"]}),\" \",String(value)]},key);})})]}),nodeDetails.details&&/*#__PURE__*/_jsxs(Card,{size:\"small\",children:[/*#__PURE__*/_jsx(Text,{strong:true,children:\"\\u8BE6\\u7EC6\\u4FE1\\u606F\"}),/*#__PURE__*/_jsx(\"div\",{style:{marginTop:8},children:/*#__PURE__*/_jsx(\"pre\",{style:{whiteSpace:'pre-wrap',fontSize:'12px'},children:JSON.stringify(nodeDetails.details,null,2)})})]})]})})});return/*#__PURE__*/_jsxs(\"div\",{className:\"unified-graph-visualization\",style:{height:typeof height==='string'?height:`${height}px`,width:'100%',overflow:'visible',display:'flex',flexDirection:'column'},children:[showControls&&renderControls(),/*#__PURE__*/_jsx(Spin,{spinning:loading,children:/*#__PURE__*/_jsx(\"div\",{style:{height:showControls?'calc(100% - 60px)':'100%',width:'100%',overflow:'visible',flex:1},children:/*#__PURE__*/_jsx(EnhancedGraphVisualization,{data:graphData,onNodeClick:handleNodeClick,height:700,layoutType:\"force\",showAnimation:showAnimation,showMiniMap:false,enableClustering:true,disableBuiltinNodeInfo:disableEnhancedNodeInfo})})}),/*#__PURE__*/_jsx(Drawer,{title:\"\\u56FE\\u8C31\\u8BBE\\u7F6E\",placement:\"right\",width:350,open:showSettings,onClose:()=>setShowSettings(false),children:renderDataSourceSettings()}),!disableBuiltinNodeDetail&&renderNodeDetails()]});};export default UnifiedGraphVisualization;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}