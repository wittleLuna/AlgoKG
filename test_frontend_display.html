<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端图谱显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .warning { color: #faad14; }
        .info { color: #1890ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .graph-panel {
            border: 2px solid #1890ff;
            border-radius: 6px;
            margin: 10px 0;
            background: #fafafa;
        }
        .panel-header {
            background: #1890ff;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }
        .panel-content {
            padding: 20px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f8ff;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #52c41a; }
        .status-error { background: #ff4d4f; }
        .status-warning { background: #faad14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 前端图谱显示测试</h1>
        
        <div class="test-section">
            <h2>1. 后端API连接测试</h2>
            <button onclick="testBackendConnection()">测试后端连接</button>
            <div id="backend-status"></div>
        </div>
        
        <div class="test-section">
            <h2>2. API响应测试</h2>
            <button onclick="testAPIResponse()">获取API响应</button>
            <div id="api-response-status"></div>
        </div>
        
        <div class="test-section">
            <h2>3. 图谱数据验证</h2>
            <button onclick="validateGraphData()">验证图谱数据</button>
            <div id="validation-status"></div>
        </div>
        
        <div class="test-section">
            <h2>4. 前端显示条件测试</h2>
            <button onclick="testDisplayConditions()">测试显示条件</button>
            <div id="display-conditions"></div>
        </div>
        
        <div class="test-section">
            <h2>5. 模拟图谱面板</h2>
            <div id="simulated-panel"></div>
        </div>
        
        <div class="test-section">
            <h2>6. 调试信息</h2>
            <button onclick="clearDebugInfo()">清空调试信息</button>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        let currentApiResponse = null;
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            updateDebugInfo();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `<pre>${debugLog.slice(-20).join('\n')}</pre>`;
        }
        
        function clearDebugInfo() {
            debugLog = [];
            updateDebugInfo();
        }
        
        async function testBackendConnection() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<p class="info">正在测试后端连接...</p>';
            log('开始测试后端连接');
            
            try {
                const response = await fetch('http://localhost:8000/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<p class="success"><span class="status-indicator status-success"></span>后端服务连接正常</p>';
                    log('后端服务连接成功', 'success');
                    return true;
                } else {
                    statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>后端服务异常 (状态码: ${response.status})</p>`;
                    log(`后端服务异常: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>无法连接到后端服务: ${error.message}</p>`;
                log(`后端连接失败: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testAPIResponse() {
            const statusDiv = document.getElementById('api-response-status');
            statusDiv.innerHTML = '<p class="info">正在获取API响应...</p>';
            log('开始测试API响应');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/qa/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: '什么是回溯算法？',
                        query_type: 'concept_explanation',
                        session_id: 'frontend_test'
                    })
                });
                
                if (response.ok) {
                    currentApiResponse = await response.json();
                    statusDiv.innerHTML = `
                        <p class="success"><span class="status-indicator status-success"></span>API响应成功</p>
                        <p>响应ID: ${currentApiResponse.response_id || 'N/A'}</p>
                        <p>查询: ${currentApiResponse.query || 'N/A'}</p>
                        <p>实体: ${JSON.stringify(currentApiResponse.entities || [])}</p>
                        <p>状态: ${currentApiResponse.status || 'N/A'}</p>
                    `;
                    log(`API响应成功: ${currentApiResponse.response_id}`, 'success');
                    return true;
                } else {
                    statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>API请求失败 (状态码: ${response.status})</p>`;
                    log(`API请求失败: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>API请求异常: ${error.message}</p>`;
                log(`API请求异常: ${error.message}`, 'error');
                return false;
            }
        }
        
        function validateGraphData() {
            const statusDiv = document.getElementById('validation-status');
            
            if (!currentApiResponse) {
                statusDiv.innerHTML = '<p class="warning"><span class="status-indicator status-warning"></span>请先获取API响应</p>';
                log('验证失败: 没有API响应数据', 'warning');
                return false;
            }
            
            log('开始验证图谱数据');
            
            const graphData = currentApiResponse.graph_data;
            let validationResults = [];
            
            // 检查graph_data存在
            const hasGraphData = graphData !== null && graphData !== undefined;
            validationResults.push(`graph_data存在: ${hasGraphData ? '✅' : '❌'}`);
            log(`graph_data存在: ${hasGraphData}`);
            
            if (!hasGraphData) {
                statusDiv.innerHTML = `
                    <div>
                        <p class="error"><span class="status-indicator status-error"></span>图谱数据验证失败</p>
                        <ul><li>${validationResults[0]}</li></ul>
                        <p>可用字段: ${Object.keys(currentApiResponse).join(', ')}</p>
                    </div>
                `;
                log('图谱数据验证失败: graph_data不存在', 'error');
                return false;
            }
            
            // 检查nodes
            const nodes = graphData.nodes;
            const nodesIsArray = Array.isArray(nodes);
            const nodesLength = nodesIsArray ? nodes.length : 0;
            
            validationResults.push(`nodes是数组: ${nodesIsArray ? '✅' : '❌'}`);
            validationResults.push(`nodes长度: ${nodesLength}`);
            validationResults.push(`nodes长度>0: ${nodesLength > 0 ? '✅' : '❌'}`);
            
            log(`nodes验证: 是数组=${nodesIsArray}, 长度=${nodesLength}`);
            
            // 检查edges
            const edges = graphData.edges;
            const edgesIsArray = Array.isArray(edges);
            const edgesLength = edgesIsArray ? edges.length : 0;
            
            validationResults.push(`edges是数组: ${edgesIsArray ? '✅' : '❌'}`);
            validationResults.push(`edges长度: ${edgesLength}`);
            
            // 检查其他字段
            validationResults.push(`center_node: ${graphData.center_node || 'N/A'}`);
            validationResults.push(`layout_type: ${graphData.layout_type || 'N/A'}`);
            
            const isValid = hasGraphData && nodesIsArray && nodesLength > 0;
            
            statusDiv.innerHTML = `
                <div>
                    <p class="${isValid ? 'success' : 'error'}">
                        <span class="status-indicator ${isValid ? 'status-success' : 'status-error'}"></span>
                        图谱数据验证${isValid ? '成功' : '失败'}
                    </p>
                    <ul>
                        ${validationResults.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    ${isValid ? `
                        <h4>节点示例:</h4>
                        <pre>${JSON.stringify(nodes[0], null, 2)}</pre>
                    ` : ''}
                </div>
            `;
            
            log(`图谱数据验证${isValid ? '成功' : '失败'}`, isValid ? 'success' : 'error');
            return isValid;
        }
        
        function testDisplayConditions() {
            const statusDiv = document.getElementById('display-conditions');
            
            if (!currentApiResponse || !currentApiResponse.graph_data) {
                statusDiv.innerHTML = '<p class="warning"><span class="status-indicator status-warning"></span>请先获取并验证API响应</p>';
                log('显示条件测试失败: 没有有效的图谱数据', 'warning');
                return false;
            }
            
            log('开始测试前端显示条件');
            
            const graphData = currentApiResponse.graph_data;
            
            // 模拟前端显示条件 (来自MessageItem.tsx)
            const condition1 = graphData !== null && graphData !== undefined;
            const condition2 = Array.isArray(graphData.nodes);
            const condition3 = graphData.nodes && graphData.nodes.length > 0;
            
            const shouldDisplay = condition1 && condition2 && condition3;
            
            log(`显示条件: condition1=${condition1}, condition2=${condition2}, condition3=${condition3}`);
            log(`最终判断: shouldDisplay=${shouldDisplay}`, shouldDisplay ? 'success' : 'error');
            
            statusDiv.innerHTML = `
                <div>
                    <h4>前端显示条件 (MessageItem.tsx逻辑):</h4>
                    <ul>
                        <li>response?.graph_data: ${condition1 ? '✅' : '❌'}</li>
                        <li>Array.isArray(response.graph_data.nodes): ${condition2 ? '✅' : '❌'}</li>
                        <li>response.graph_data.nodes.length > 0: ${condition3 ? '✅' : '❌'}</li>
                    </ul>
                    <h4>最终判断:</h4>
                    <p class="${shouldDisplay ? 'success' : 'error'}" style="font-size: 18px; font-weight: bold;">
                        <span class="status-indicator ${shouldDisplay ? 'status-success' : 'status-error'}"></span>
                        ${shouldDisplay ? '✅ 应该显示知识图谱面板' : '❌ 不会显示知识图谱面板'}
                    </p>
                    ${shouldDisplay ? `
                        <p>节点数量: ${graphData.nodes.length}</p>
                        <p>边数量: ${graphData.edges ? graphData.edges.length : 0}</p>
                        <p>中心节点: ${graphData.center_node}</p>
                    ` : ''}
                </div>
            `;
            
            // 如果应该显示，创建模拟面板
            if (shouldDisplay) {
                createSimulatedPanel(graphData);
            }
            
            return shouldDisplay;
        }
        
        function createSimulatedPanel(graphData) {
            const panelDiv = document.getElementById('simulated-panel');
            
            panelDiv.innerHTML = `
                <div class="graph-panel">
                    <div class="panel-header">
                        🕸️ 知识图谱 (${graphData.nodes.length}个节点)
                    </div>
                    <div class="panel-content">
                        <div style="text-align: center;">
                            <h3>✅ 图谱应该在这里显示</h3>
                            <p>节点数量: ${graphData.nodes.length}</p>
                            <p>边数量: ${graphData.edges.length}</p>
                            <p>中心节点: ${graphData.center_node}</p>
                            <p>布局类型: ${graphData.layout_type}</p>
                            <p style="color: #666; margin-top: 20px;">
                                实际的UnifiedGraphVisualization组件会在React应用中渲染
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            log(`创建模拟图谱面板: ${graphData.nodes.length}个节点`, 'success');
        }
        
        // 页面加载时自动开始测试
        window.onload = function() {
            log('页面加载完成，开始自动测试');
            setTimeout(async () => {
                const backendOk = await testBackendConnection();
                if (backendOk) {
                    setTimeout(async () => {
                        const apiOk = await testAPIResponse();
                        if (apiOk) {
                            setTimeout(() => {
                                const validationOk = validateGraphData();
                                if (validationOk) {
                                    setTimeout(() => {
                                        testDisplayConditions();
                                    }, 500);
                                }
                            }, 500);
                        }
                    }, 500);
                }
            }, 1000);
        };
    </script>
</body>
</html>
