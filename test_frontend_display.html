<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯å›¾è°±æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .warning { color: #faad14; }
        .info { color: #1890ff; }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        .graph-panel {
            border: 2px solid #1890ff;
            border-radius: 6px;
            margin: 10px 0;
            background: #fafafa;
        }
        .panel-header {
            background: #1890ff;
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }
        .panel-content {
            padding: 20px;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f8ff;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #52c41a; }
        .status-error { background: #ff4d4f; }
        .status-warning { background: #faad14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å‰ç«¯å›¾è°±æ˜¾ç¤ºæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. åç«¯APIè¿æ¥æµ‹è¯•</h2>
            <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
            <div id="backend-status"></div>
        </div>
        
        <div class="test-section">
            <h2>2. APIå“åº”æµ‹è¯•</h2>
            <button onclick="testAPIResponse()">è·å–APIå“åº”</button>
            <div id="api-response-status"></div>
        </div>
        
        <div class="test-section">
            <h2>3. å›¾è°±æ•°æ®éªŒè¯</h2>
            <button onclick="validateGraphData()">éªŒè¯å›¾è°±æ•°æ®</button>
            <div id="validation-status"></div>
        </div>
        
        <div class="test-section">
            <h2>4. å‰ç«¯æ˜¾ç¤ºæ¡ä»¶æµ‹è¯•</h2>
            <button onclick="testDisplayConditions()">æµ‹è¯•æ˜¾ç¤ºæ¡ä»¶</button>
            <div id="display-conditions"></div>
        </div>
        
        <div class="test-section">
            <h2>5. æ¨¡æ‹Ÿå›¾è°±é¢æ¿</h2>
            <div id="simulated-panel"></div>
        </div>
        
        <div class="test-section">
            <h2>6. è°ƒè¯•ä¿¡æ¯</h2>
            <button onclick="clearDebugInfo()">æ¸…ç©ºè°ƒè¯•ä¿¡æ¯</button>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        let currentApiResponse = null;
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            updateDebugInfo();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML = `<pre>${debugLog.slice(-20).join('\n')}</pre>`;
        }
        
        function clearDebugInfo() {
            debugLog = [];
            updateDebugInfo();
        }
        
        async function testBackendConnection() {
            const statusDiv = document.getElementById('backend-status');
            statusDiv.innerHTML = '<p class="info">æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...</p>';
            log('å¼€å§‹æµ‹è¯•åç«¯è¿æ¥');
            
            try {
                const response = await fetch('http://localhost:8000/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<p class="success"><span class="status-indicator status-success"></span>åç«¯æœåŠ¡è¿æ¥æ­£å¸¸</p>';
                    log('åç«¯æœåŠ¡è¿æ¥æˆåŠŸ', 'success');
                    return true;
                } else {
                    statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>åç«¯æœåŠ¡å¼‚å¸¸ (çŠ¶æ€ç : ${response.status})</p>`;
                    log(`åç«¯æœåŠ¡å¼‚å¸¸: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡: ${error.message}</p>`;
                log(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testAPIResponse() {
            const statusDiv = document.getElementById('api-response-status');
            statusDiv.innerHTML = '<p class="info">æ­£åœ¨è·å–APIå“åº”...</p>';
            log('å¼€å§‹æµ‹è¯•APIå“åº”');
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/qa/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: 'ä»€ä¹ˆæ˜¯å›æº¯ç®—æ³•ï¼Ÿ',
                        query_type: 'concept_explanation',
                        session_id: 'frontend_test'
                    })
                });
                
                if (response.ok) {
                    currentApiResponse = await response.json();
                    statusDiv.innerHTML = `
                        <p class="success"><span class="status-indicator status-success"></span>APIå“åº”æˆåŠŸ</p>
                        <p>å“åº”ID: ${currentApiResponse.response_id || 'N/A'}</p>
                        <p>æŸ¥è¯¢: ${currentApiResponse.query || 'N/A'}</p>
                        <p>å®ä½“: ${JSON.stringify(currentApiResponse.entities || [])}</p>
                        <p>çŠ¶æ€: ${currentApiResponse.status || 'N/A'}</p>
                    `;
                    log(`APIå“åº”æˆåŠŸ: ${currentApiResponse.response_id}`, 'success');
                    return true;
                } else {
                    statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${response.status})</p>`;
                    log(`APIè¯·æ±‚å¤±è´¥: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p class="error"><span class="status-indicator status-error"></span>APIè¯·æ±‚å¼‚å¸¸: ${error.message}</p>`;
                log(`APIè¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                return false;
            }
        }
        
        function validateGraphData() {
            const statusDiv = document.getElementById('validation-status');
            
            if (!currentApiResponse) {
                statusDiv.innerHTML = '<p class="warning"><span class="status-indicator status-warning"></span>è¯·å…ˆè·å–APIå“åº”</p>';
                log('éªŒè¯å¤±è´¥: æ²¡æœ‰APIå“åº”æ•°æ®', 'warning');
                return false;
            }
            
            log('å¼€å§‹éªŒè¯å›¾è°±æ•°æ®');
            
            const graphData = currentApiResponse.graph_data;
            let validationResults = [];
            
            // æ£€æŸ¥graph_dataå­˜åœ¨
            const hasGraphData = graphData !== null && graphData !== undefined;
            validationResults.push(`graph_dataå­˜åœ¨: ${hasGraphData ? 'âœ…' : 'âŒ'}`);
            log(`graph_dataå­˜åœ¨: ${hasGraphData}`);
            
            if (!hasGraphData) {
                statusDiv.innerHTML = `
                    <div>
                        <p class="error"><span class="status-indicator status-error"></span>å›¾è°±æ•°æ®éªŒè¯å¤±è´¥</p>
                        <ul><li>${validationResults[0]}</li></ul>
                        <p>å¯ç”¨å­—æ®µ: ${Object.keys(currentApiResponse).join(', ')}</p>
                    </div>
                `;
                log('å›¾è°±æ•°æ®éªŒè¯å¤±è´¥: graph_dataä¸å­˜åœ¨', 'error');
                return false;
            }
            
            // æ£€æŸ¥nodes
            const nodes = graphData.nodes;
            const nodesIsArray = Array.isArray(nodes);
            const nodesLength = nodesIsArray ? nodes.length : 0;
            
            validationResults.push(`nodesæ˜¯æ•°ç»„: ${nodesIsArray ? 'âœ…' : 'âŒ'}`);
            validationResults.push(`nodesé•¿åº¦: ${nodesLength}`);
            validationResults.push(`nodesé•¿åº¦>0: ${nodesLength > 0 ? 'âœ…' : 'âŒ'}`);
            
            log(`nodeséªŒè¯: æ˜¯æ•°ç»„=${nodesIsArray}, é•¿åº¦=${nodesLength}`);
            
            // æ£€æŸ¥edges
            const edges = graphData.edges;
            const edgesIsArray = Array.isArray(edges);
            const edgesLength = edgesIsArray ? edges.length : 0;
            
            validationResults.push(`edgesæ˜¯æ•°ç»„: ${edgesIsArray ? 'âœ…' : 'âŒ'}`);
            validationResults.push(`edgesé•¿åº¦: ${edgesLength}`);
            
            // æ£€æŸ¥å…¶ä»–å­—æ®µ
            validationResults.push(`center_node: ${graphData.center_node || 'N/A'}`);
            validationResults.push(`layout_type: ${graphData.layout_type || 'N/A'}`);
            
            const isValid = hasGraphData && nodesIsArray && nodesLength > 0;
            
            statusDiv.innerHTML = `
                <div>
                    <p class="${isValid ? 'success' : 'error'}">
                        <span class="status-indicator ${isValid ? 'status-success' : 'status-error'}"></span>
                        å›¾è°±æ•°æ®éªŒè¯${isValid ? 'æˆåŠŸ' : 'å¤±è´¥'}
                    </p>
                    <ul>
                        ${validationResults.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    ${isValid ? `
                        <h4>èŠ‚ç‚¹ç¤ºä¾‹:</h4>
                        <pre>${JSON.stringify(nodes[0], null, 2)}</pre>
                    ` : ''}
                </div>
            `;
            
            log(`å›¾è°±æ•°æ®éªŒè¯${isValid ? 'æˆåŠŸ' : 'å¤±è´¥'}`, isValid ? 'success' : 'error');
            return isValid;
        }
        
        function testDisplayConditions() {
            const statusDiv = document.getElementById('display-conditions');
            
            if (!currentApiResponse || !currentApiResponse.graph_data) {
                statusDiv.innerHTML = '<p class="warning"><span class="status-indicator status-warning"></span>è¯·å…ˆè·å–å¹¶éªŒè¯APIå“åº”</p>';
                log('æ˜¾ç¤ºæ¡ä»¶æµ‹è¯•å¤±è´¥: æ²¡æœ‰æœ‰æ•ˆçš„å›¾è°±æ•°æ®', 'warning');
                return false;
            }
            
            log('å¼€å§‹æµ‹è¯•å‰ç«¯æ˜¾ç¤ºæ¡ä»¶');
            
            const graphData = currentApiResponse.graph_data;
            
            // æ¨¡æ‹Ÿå‰ç«¯æ˜¾ç¤ºæ¡ä»¶ (æ¥è‡ªMessageItem.tsx)
            const condition1 = graphData !== null && graphData !== undefined;
            const condition2 = Array.isArray(graphData.nodes);
            const condition3 = graphData.nodes && graphData.nodes.length > 0;
            
            const shouldDisplay = condition1 && condition2 && condition3;
            
            log(`æ˜¾ç¤ºæ¡ä»¶: condition1=${condition1}, condition2=${condition2}, condition3=${condition3}`);
            log(`æœ€ç»ˆåˆ¤æ–­: shouldDisplay=${shouldDisplay}`, shouldDisplay ? 'success' : 'error');
            
            statusDiv.innerHTML = `
                <div>
                    <h4>å‰ç«¯æ˜¾ç¤ºæ¡ä»¶ (MessageItem.tsxé€»è¾‘):</h4>
                    <ul>
                        <li>response?.graph_data: ${condition1 ? 'âœ…' : 'âŒ'}</li>
                        <li>Array.isArray(response.graph_data.nodes): ${condition2 ? 'âœ…' : 'âŒ'}</li>
                        <li>response.graph_data.nodes.length > 0: ${condition3 ? 'âœ…' : 'âŒ'}</li>
                    </ul>
                    <h4>æœ€ç»ˆåˆ¤æ–­:</h4>
                    <p class="${shouldDisplay ? 'success' : 'error'}" style="font-size: 18px; font-weight: bold;">
                        <span class="status-indicator ${shouldDisplay ? 'status-success' : 'status-error'}"></span>
                        ${shouldDisplay ? 'âœ… åº”è¯¥æ˜¾ç¤ºçŸ¥è¯†å›¾è°±é¢æ¿' : 'âŒ ä¸ä¼šæ˜¾ç¤ºçŸ¥è¯†å›¾è°±é¢æ¿'}
                    </p>
                    ${shouldDisplay ? `
                        <p>èŠ‚ç‚¹æ•°é‡: ${graphData.nodes.length}</p>
                        <p>è¾¹æ•°é‡: ${graphData.edges ? graphData.edges.length : 0}</p>
                        <p>ä¸­å¿ƒèŠ‚ç‚¹: ${graphData.center_node}</p>
                    ` : ''}
                </div>
            `;
            
            // å¦‚æœåº”è¯¥æ˜¾ç¤ºï¼Œåˆ›å»ºæ¨¡æ‹Ÿé¢æ¿
            if (shouldDisplay) {
                createSimulatedPanel(graphData);
            }
            
            return shouldDisplay;
        }
        
        function createSimulatedPanel(graphData) {
            const panelDiv = document.getElementById('simulated-panel');
            
            panelDiv.innerHTML = `
                <div class="graph-panel">
                    <div class="panel-header">
                        ğŸ•¸ï¸ çŸ¥è¯†å›¾è°± (${graphData.nodes.length}ä¸ªèŠ‚ç‚¹)
                    </div>
                    <div class="panel-content">
                        <div style="text-align: center;">
                            <h3>âœ… å›¾è°±åº”è¯¥åœ¨è¿™é‡Œæ˜¾ç¤º</h3>
                            <p>èŠ‚ç‚¹æ•°é‡: ${graphData.nodes.length}</p>
                            <p>è¾¹æ•°é‡: ${graphData.edges.length}</p>
                            <p>ä¸­å¿ƒèŠ‚ç‚¹: ${graphData.center_node}</p>
                            <p>å¸ƒå±€ç±»å‹: ${graphData.layout_type}</p>
                            <p style="color: #666; margin-top: 20px;">
                                å®é™…çš„UnifiedGraphVisualizationç»„ä»¶ä¼šåœ¨Reactåº”ç”¨ä¸­æ¸²æŸ“
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            log(`åˆ›å»ºæ¨¡æ‹Ÿå›¾è°±é¢æ¿: ${graphData.nodes.length}ä¸ªèŠ‚ç‚¹`, 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•');
            setTimeout(async () => {
                const backendOk = await testBackendConnection();
                if (backendOk) {
                    setTimeout(async () => {
                        const apiOk = await testAPIResponse();
                        if (apiOk) {
                            setTimeout(() => {
                                const validationOk = validateGraphData();
                                if (validationOk) {
                                    setTimeout(() => {
                                        testDisplayConditions();
                                    }, 500);
                                }
                            }, 500);
                        }
                    }, 500);
                }
            }, 1000);
        };
    </script>
</body>
</html>
